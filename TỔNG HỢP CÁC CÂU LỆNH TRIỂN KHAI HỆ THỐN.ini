TỔNG HỢP CÁC CÂU LỆNH TRIỂN KHAI HỆ THỐNG (COMMAND LOG)
1. Cài đặt các gói thư viện phụ thuộc (Dependencies)
Trước khi biên dịch phần mềm, cần cài đặt các công cụ biên dịch và thư viện xử lý.

Bash

# Cập nhật danh sách gói phần mềm
sudo apt-get update

# Cài đặt trình biên dịch (GCC, Make) và các thư viện xử lý (XML, Regex, SSL, cURL)
sudo apt-get install -y git build-essential libpcre3 libpcre3-dev \
libssl-dev zlib1g-dev libtool automake autoconf libxml2-dev \
libyajl-dev libgeoip-dev libmaxminddb-dev libcurl4-openssl-dev \
libpcre2-dev
2. Tải và Biên dịch ModSecurity v3 (Libmodsecurity)
Cài đặt "động cơ" xử lý WAF.

Bash

# Di chuyển vào thư mục mã nguồn
cd /usr/local/src

# Tải mã nguồn ModSecurity từ GitHub (nhánh v3 master)
sudo git clone --depth 1 -b v3/master --single-branch https://github.com/SpiderLabs/ModSecurity

# Di chuyển vào thư mục vừa tải
cd ModSecurity

# Khởi tạo và cập nhật các module con
sudo git submodule init
sudo git submodule update

# Chạy script xây dựng cấu hình
sudo ./build.sh

# Cấu hình biên dịch
sudo ./configure

# Biên dịch mã nguồn (Quá trình này tốn khoảng 10-15 phút)
sudo make

# Cài đặt vào hệ thống
sudo make install
3. Tải Nginx Connector
Cầu nối để Nginx giao tiếp được với ModSecurity.

Bash

cd /usr/local/src
# Tải mã nguồn Connector
sudo git clone --depth 1 https://github.com/SpiderLabs/ModSecurity-nginx.git
4. Tải và Biên dịch Nginx (Tích hợp ModSecurity)
Cài đặt Web Server đóng vai trò Reverse Proxy.

Bash

cd /usr/local/src

# Tải mã nguồn Nginx phiên bản ổn định (1.24.0)
sudo wget http://nginx.org/download/nginx-1.24.0.tar.gz

# Giải nén
sudo tar -xvzf nginx-1.24.0.tar.gz
cd nginx-1.24.0

# Cấu hình biên dịch Nginx kèm theo module ModSecurity
sudo ./configure --prefix=/usr/local/nginx \
--user=nginx --group=nginx \
--sbin-path=/usr/local/sbin/nginx \
--conf-path=/etc/nginx/nginx.conf \
--http-log-path=/var/log/nginx/access.log \
--error-log-path=/var/log/nginx/error.log \
--pid-path=/run/nginx.pid \
--with-http_ssl_module \
--add-module=/usr/local/src/ModSecurity-nginx

# Biên dịch và cài đặt Nginx
sudo make
sudo make install
5. Cấu hình Bộ luật OWASP Core Rule Set (CRS)
Tích hợp bộ quy tắc bảo mật.

Bash

# Tạo thư mục chứa cấu hình WAF
sudo mkdir /etc/nginx/modsec
cd /etc/nginx/modsec

# Tải bộ luật OWASP CRS từ GitHub
sudo git clone https://github.com/coreruleset/coreruleset.git

# Đổi tên file cấu hình mẫu thành file chính thức
sudo mv coreruleset/crs-setup.conf.example coreruleset/crs-setup.conf

# Copy file cấu hình mặc định của ModSecurity
sudo cp /usr/local/src/ModSecurity/modsecurity.conf-recommended /etc/nginx/modsec/modsecurity.conf
sudo cp /usr/local/src/ModSecurity/unicode.mapping /etc/nginx/modsec/
6. Các lệnh Cấu hình và Vận hành (Thường xuyên dùng)
a. Chỉnh sửa file cấu hình:

Bash

# Sửa file cấu hình chính của ModSecurity (Bật/Tắt WAF)
sudo nano /etc/nginx/modsec/modsecurity.conf
# (Tìm dòng SecRuleEngine để sửa thành On hoặc DetectionOnly)

# Sửa file cấu hình Nginx (Cấu hình Proxy Pass về XAMPP)
sudo nano /etc/nginx/nginx.conf

worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Định dạng Log (để xem IP kẻ tấn công rõ ràng hơn)
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  localhost;

        location / {
            # --- CẤU HÌNH WAF (ModSecurity) ---
            modsecurity on;
            modsecurity_rules_file /etc/nginx/modsec/main.conf;

            # --- CẤU HÌNH REVERSE PROXY ---
            # Chuyển hướng về máy Windows (XAMPP)
            # Dùng IP 192.168.170.1 (Card VMnet8) để kết nối ổn định nhất
            proxy_pass http://192.168.170.1:80;

            # Các Headers quan trọng để backend nhận diện đúng Client
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Trang báo lỗi tùy chỉnh (Khi bị WAF chặn ra lỗi 403)
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}


# Tạo/Sửa file nạp luật (main.conf)
sudo nano /etc/nginx/modsec/main.conf

# 1. Nạp cấu hình cốt lõi của ModSecurity
Include /etc/nginx/modsec/modsecurity.conf

# 2. Nạp file cấu hình của bộ luật OWASP CRS
Include /etc/nginx/modsec/coreruleset/crs-setup.conf

# 3. Kích hoạt toàn bộ các luật bảo mật trong thư mục rules
Include /etc/nginx/modsec/coreruleset/rules/*.conf

b. Kiểm tra và Khởi động Nginx:

Bash

# Kiểm tra cú pháp file cấu hình (Check Syntax) - Rất quan trọng trước khi chạy
sudo nginx -t

# Khởi động Nginx
sudo systemctl start nginx

# Nạp lại cấu hình (Reload) - Dùng khi sửa file config mà không muốn tắt server
sudo systemctl reload nginx

# Dừng Nginx
sudo systemctl stop nginx
c. Giám sát Nhật ký (Logging) - Dùng để Demo:

Bash

# Xóa sạch log cũ (để demo cho sạch)
sudo truncate -s 0 /var/log/nginx/error.log

# Xem log thời gian thực (Real-time monitoring)
# Lệnh này giúp thấy ngay lập tức khi hacker bị chặn
sudo tail -f /var/log/nginx/error.log

# Tìm kiếm log cụ thể (Lọc các dòng báo Access denied)
# Dùng để chụp ảnh báo cáo các vụ tấn công đã bị chặn
sudo grep "Access denied" /var/log/nginx/error.log


<script>alert('XSS BY DUONG: TÔI ĐÃ LẤY ĐƯỢC COOKIE CỦA BẠN!')</script>

' UNION SELECT 1, tenkhachhang, matkhau, 4 FROM tbl_dangky#

' OR 1=1--
